<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LuxWatch</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">‚åö LuxWatch</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/dashboard.html">Dashboard</a></li>
                <li><a href="#" id="logoutLink" class="btn btn-secondary btn-small">Logout</a></li>
                <li><span id="userGreeting" style="color: var(--gold);"></span></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1 style="margin-top: var(--spacing-xl);">My Dashboard</h1>

        <div class="dashboard-grid">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" class="active" onclick="showSection('orders'); return false;">My Orders</a></li>
                    <li><a href="#" onclick="showSection('profile'); return false;">Profile</a></li>
                </ul>
            </div>

            <!-- Main Content -->
            <div>
                <!-- Orders Section -->
                <div id="ordersSection">
                    <div class="card">
                        <h2>My Orders</h2>
                        <div id="ordersContainer">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" style="display: none;">
                    <div class="card">
                        <h2>My Profile</h2>
                        <div id="profileContainer">
                            <div class="spinner"></div>
                        </div>
                    </div>

                    <!-- VULNERABLE: IDOR - Can view other users' profiles -->
                    <div class="card" style="margin-top: var(--spacing-lg);">
                        <h3>üîç View User Profile (IDOR Demo)</h3>
                        <p style="color: var(--text-muted);">Try changing the user ID to view other users' data</p>
                        <div class="form-group">
                            <label>User ID:</label>
                            <input type="number" id="userIdInput" value="1" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="viewUserProfile()">View Profile</button>
                        <div id="idorResult" style="margin-top: var(--spacing-md);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        let currentUser = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const hasAuth = await requireAuth();
            if (!hasAuth) return;

            await loadCurrentUser();
            await loadOrders();
        });

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user');
                currentUser = await response.json();

                document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.username}`;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders/my');
                const orders = await response.json();

                const container = document.getElementById('ordersContainer');

                if (orders.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No orders yet</p>';
                    return;
                }

                container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Product</th>
                <th>Brand</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => `
                <tr>
                  <td>#${order.id}</td>
                  <td>${order.name}</td>
                  <td>${order.brand}</td>
                  <td>${order.quantity}</td>
                  <td>$${order.total_price.toLocaleString()}</td>
                  <td><span class="badge badge-${order.status === 'pending' ? 'pending' : 'success'}">${order.status}</span></td>
                  <td>${formatDate(order.created_at)}</td>
                  <td><button class="btn btn-secondary btn-small" onclick="viewOrder(${order.id})">View</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersContainer').innerHTML =
                    '<p style="color: var(--error);">Failed to load orders</p>';
            }
        }

        // VULNERABLE: IDOR - Can view any order by ID
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const order = await response.json();

                if (response.ok) {
                    alert(`Order #${order.id}\nProduct ID: ${order.product_id}\nQuantity: ${order.quantity}\nTotal: $${order.total_price}\nStatus: ${order.status}\n\nVulnerability: No ownership check!`);
                } else {
                    showAlert('Order not found', 'error');
                }
            } catch (error) {
                console.error('Error viewing order:', error);
            }
        }

        async function loadProfile() {
            if (!currentUser) await loadCurrentUser();

            const container = document.getElementById('profileContainer');
            container.innerHTML = `
        <div class="form-group">
          <label>User ID:</label>
          <input type="text" value="${currentUser.id}" disabled>
        </div>
        <div class="form-group">
          <label>Username:</label>
          <input type="text" value="${currentUser.username}" disabled>
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input type="text" value="${currentUser.email}" disabled>
        </div>
        <div class="form-group">
          <label>Role:</label>
          <input type="text" value="${currentUser.role}" disabled>
        </div>
      `;
        }

        // VULNERABLE: IDOR - View any user's profile
        async function viewUserProfile() {
            const userId = document.getElementById('userIdInput').value;

            try {
                const response = await fetch(`/api/users/${userId}`);
                const user = await response.json();

                if (response.ok) {
                    document.getElementById('idorResult').innerHTML = `
            <div class="alert alert-warning">
              <strong>‚ö†Ô∏è IDOR Vulnerability Exploited!</strong><br>
              You can view any user's sensitive data by changing the ID.
            </div>
            <div style="background: var(--dark-elevated); padding: var(--spacing-md); border-radius: var(--radius-md); margin-top: var(--spacing-md);">
              <p><strong>User ID:</strong> ${user.id}</p>
              <p><strong>Username:</strong> ${user.username}</p>
              <p><strong>Email:</strong> ${user.email}</p>
              <p><strong>Password:</strong> ${user.password} (Plain text!)</p>
              <p><strong>Role:</strong> ${user.role}</p>
            </div>
          `;
                } else {
                    showAlert('User not found', 'error');
                }
            } catch (error) {
                console.error('Error viewing user:', error);
                showAlert('Failed to load user data', 'error');
            }
        }

        function showSection(section) {
            // Hide all sections
            document.getElementById('ordersSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';

            // Update sidebar
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            if (section === 'orders') {
                document.getElementById('ordersSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[0].classList.add('active');
            } else if (section === 'profile') {
                document.getElementById('profileSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[1].classList.add('active');
                loadProfile();
            }
        }
    </script>
</body>

</html>