<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - LuxWatch</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">‚åö LuxWatch Admin</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/admin.html">Admin Panel</a></li>
                <li><a href="#" id="logoutLink" class="btn btn-secondary btn-small">Logout</a></li>
                <li><span id="userGreeting" style="color: var(--gold);"></span></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1 style="margin-top: var(--spacing-xl);">üîê Admin Panel</h1>

        <div class="dashboard-grid">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" class="active" onclick="showSection('products'); return false;">Products</a></li>
                    <li><a href="#" onclick="showSection('users'); return false;">Users</a></li>
                    <li><a href="#" onclick="showSection('orders'); return false;">Orders</a></li>
                    <li><a href="#" onclick="showSection('debug'); return false;">Debug SQL</a></li>
                </ul>
            </div>

            <!-- Main Content -->
            <div>
                <!-- Products Section -->
                <div id="productsSection">
                    <div class="card">
                        <div class="flex-between mb-2">
                            <h2>Manage Products</h2>
                            <button class="btn btn-primary" onclick="showAddProductForm()">+ Add Product</button>
                        </div>
                        <div id="productsContainer">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="usersSection" style="display: none;">
                    <div class="card">
                        <h2>Manage Users</h2>
                        <div id="usersContainer">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="ordersSection" style="display: none;">
                    <div class="card">
                        <h2>Manage Orders</h2>
                        <div id="ordersContainer">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Debug SQL Section (EXTREMELY VULNERABLE) -->
                <div id="debugSection" style="display: none;">
                    <div class="card">
                        <h2>üêõ Debug SQL Query</h2>
                        <div class="alert alert-error">
                            <strong>‚ö†Ô∏è EXTREME VULNERABILITY!</strong><br>
                            This endpoint allows arbitrary SQL execution. Perfect for demonstrating SQL injection
                            attacks.
                        </div>

                        <div class="form-group">
                            <label>SQL Query:</label>
                            <textarea id="sqlQuery" placeholder="SELECT * FROM users"
                                style="font-family: monospace;"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="executeQuery()">Execute Query</button>

                        <div id="queryResult" style="margin-top: var(--spacing-lg);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Add Product</h2>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="return handleProductSubmit(event)">
                <input type="hidden" id="productId">

                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label>Brand:</label>
                    <input type="text" id="productBrand" required>
                </div>

                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="productDescription" required></textarea>
                </div>

                <div class="form-group">
                    <label>Price ($):</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Image Filename:</label>
                    <input type="text" id="productImage" placeholder="watch.jpg" required>
                </div>

                <div class="form-group">
                    <label>Stock:</label>
                    <input type="number" id="productStock" required>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Product</button>
            </form>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        let currentEditId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const isAdmin = await requireAdmin();
            if (!isAdmin) return;

            await loadProducts();
        });

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const products = await response.json();

                const container = document.getElementById('productsContainer');
                container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Brand</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${products.map(product => `
                <tr>
                  <td>${product.id}</td>
                  <td>${product.name}</td>
                  <td>${product.brand}</td>
                  <td>$${product.price.toLocaleString()}</td>
                  <td>${product.stock}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick="editProduct(${product.id})">Edit</button>
                    <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();

                const container = document.getElementById('usersContainer');
                container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr>
                  <td>${user.id}</td>
                  <td>${user.username}</td>
                  <td>${user.email}</td>
                  <td><span class="badge ${user.role === 'admin' ? 'badge-gold' : 'badge-success'}">${user.role}</span></td>
                  <td>${formatDate(user.created_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders');
                const orders = await response.json();

                const container = document.getElementById('ordersContainer');
                container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>User</th>
                <th>Product</th>
                <th>Brand</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => `
                <tr>
                  <td>#${order.id}</td>
                  <td>${order.username}</td>
                  <td>${order.product_name}</td>
                  <td>${order.brand}</td>
                  <td>${order.quantity}</td>
                  <td>$${order.total_price.toLocaleString()}</td>
                  <td><span class="badge badge-pending">${order.status}</span></td>
                  <td>${formatDate(order.created_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function showSection(section) {
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('usersSection').style.display = 'none';
            document.getElementById('ordersSection').style.display = 'none';
            document.getElementById('debugSection').style.display = 'none';

            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });

            if (section === 'products') {
                document.getElementById('productsSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[0].classList.add('active');
            } else if (section === 'users') {
                document.getElementById('usersSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[1].classList.add('active');
                loadUsers();
            } else if (section === 'orders') {
                document.getElementById('ordersSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[2].classList.add('active');
                loadOrders();
            } else if (section === 'debug') {
                document.getElementById('debugSection').style.display = 'block';
                document.querySelectorAll('.sidebar-nav a')[3].classList.add('active');
            }
        }

        function showAddProductForm() {
            currentEditId = null;
            document.getElementById('productModalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.add('active');
        }

        async function editProduct(id) {
            currentEditId = id;

            try {
                const response = await fetch(`/api/products/${id}`);
                const product = await response.json();

                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productBrand').value = product.brand;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productImage').value = product.image;
                document.getElementById('productStock').value = product.stock;

                document.getElementById('productModal').classList.add('active');
            } catch (error) {
                console.error('Error loading product:', error);
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function handleProductSubmit(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                image: document.getElementById('productImage').value,
                stock: parseInt(document.getElementById('productStock').value)
            };

            try {
                let response;
                if (currentEditId) {
                    response = await fetch(`/api/admin/products/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/admin/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();

                if (response.ok) {
                    showAlert(currentEditId ? 'Product updated!' : 'Product added!', 'success');
                    closeProductModal();
                    loadProducts();
                } else {
                    showAlert(result.error || 'Operation failed', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showAlert('Failed to save product', 'error');
            }

            return false;
        }

        // VULNERABLE: CSRF - No CSRF token validation
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('Product deleted!', 'success');
                    loadProducts();
                } else {
                    showAlert(result.error || 'Delete failed', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Failed to delete product', 'error');
            }
        }

        // VULNERABLE: Arbitrary SQL execution
        async function executeQuery() {
            const query = document.getElementById('sqlQuery').value;

            if (!query.trim()) {
                showAlert('Please enter a SQL query', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/admin/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('queryResult').innerHTML = `
            <div class="alert alert-success">Query executed successfully!</div>
            <div style="background: var(--dark-elevated); padding: var(--spacing-md); border-radius: var(--radius-md); overflow-x: auto;">
              <pre style="margin: 0; color: var(--gold);">${JSON.stringify(result, null, 2)}</pre>
            </div>
          `;
                } else {
                    document.getElementById('queryResult').innerHTML = `
            <div class="alert alert-error">
              <strong>Query failed:</strong><br>
              ${result.details || result.error}
            </div>
          `;
                }
            } catch (error) {
                console.error('Query error:', error);
                showAlert('Failed to execute query', 'error');
            }
        }
    </script>
</body>

</html>